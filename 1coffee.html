<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å’–å•¡é»é¤POSç³»çµ± (å„ªåŒ–éµç›¤ä½ˆå±€)</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* æ·ºç°è‰²èƒŒæ™¯ */
        }
        .btn-menu {
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        .btn-menu:active {
            transform: scale(0.98);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-keypad {
             transition: background-color 0.1s ease;
        }
        .btn-keypad:active {
            background-color: #d1d5db; /* é»æ“Šæ™‚é¡è‰²è®Šæ·± */
        }
        .keypad-special:active {
             background-color: #fb7185; /* ç‰¹æ®Šéµé»æ“Šæ™‚é¡è‰²è®Šæ·± */
        }
        .item-setting-row:hover {
            background-color: #fef3c7; /* æ·ºç¥ç€è‰²ç”¨æ–¼ç·¨è¼¯æç¤º */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="pos-app" class="w-full max-w-6xl bg-white shadow-2xl rounded-xl overflow-hidden flex flex-col lg:flex-row h-[90vh]">

        <!-- å·¦å´: èœå–®å€ -->
        <div class="lg:w-3/5 p-6 space-y-6 overflow-y-auto bg-gray-50 border-r border-gray-200">
            <header class="pb-4 border-b">
                <!-- é½’è¼ªåœ–ç¤ºå’Œæ¨™é¡Œ -->
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold text-gray-800">å’–å•¡é»é¤èœå–®</h1>
                    <button onclick="openSettings()" class="text-gray-500 hover:text-amber-600 transition duration-150 p-2 rounded-full hover:bg-gray-200" title="é–‹å•Ÿè¨­å®š">
                        <!-- é½’è¼ªåœ–ç¤º (Settings Icon) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 .73 1.73v.52a2 2 0 0 1-.73 1.73l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-.73-1.73v-.52a2 2 0 0 1 .73-1.73l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">é»æ“Šå“é …åŠ å…¥è¨‚å–® (ç·¨è™Ÿ: <span id="order-id" class="font-semibold text-red-500">1</span>)</p>
            </header>

            <!-- èœå–®é …ç›®åˆ—è¡¨ -->
            <div id="menu-items" class="space-y-6">
                <!-- èœå–®æŒ‰éˆ•å°‡ç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å³å´: è¨‚å–®èˆ‡çµå¸³å€ -->
        <div class="lg:w-2/5 flex flex-col p-6 space-y-4 bg-gray-100">
            
            <!-- è¦–åœ–åˆ‡æ›æ¨™ç±¤ (Tab) -->
            <div class="flex border-b border-gray-300">
                <button id="tab-order" onclick="toggleView('order')" class="flex-1 py-2 px-4 text-center font-bold text-lg rounded-t-lg transition-colors border-b-4 border-amber-500 text-amber-600">
                    ç•¶å‰è¨‚å–®
                </button>
                <button id="tab-history" onclick="toggleView('history')" class="flex-1 py-2 px-4 text-center font-bold text-lg rounded-t-lg text-gray-500 hover:text-gray-700 border-b-4 border-transparent">
                    æ­·å²è¨‚å–®
                </button>
            </div>

            <!-- 1. ç•¶å‰è¨‚å–®è¦–åœ– (é è¨­é¡¯ç¤º) -->
            <div id="order-view" class="flex flex-col flex-grow space-y-4">
                
                <!-- è¨‚å–®æ˜ç´° -->
                <div id="order-details" class="flex-grow overflow-y-auto bg-white p-4 rounded-lg shadow-inner space-y-2 text-sm">
                    <!-- è¨‚å–®æ˜ç´°å°‡ç”± JS ç”Ÿæˆ -->
                    <p class="text-gray-500 text-center py-4">ç›®å‰ç„¡å“é …</p>
                </div>

                <!-- ç¸½è¨ˆèˆ‡æ‰¾é›¶ -->
                <div class="space-y-3 pt-4 border-t border-gray-200">
                    <div class="flex justify-between items-center text-xl font-bold text-gray-900">
                        <span>ç¸½è¨ˆé‡‘é¡ (TWD):</span>
                        <span id="total-amount" class="text-red-600">$0</span>
                    </div>
                </div>

                <!-- æ”¯ä»˜å€å¡Š -->
                <div class="bg-white p-4 rounded-lg shadow space-y-3">
                    <div class="flex justify-between items-center">
                        <label for="amount-received" class="text-lg font-medium text-gray-700">é¡§å®¢ä»˜ç¾é‡‘é¡:</label>
                        <input type="text" id="amount-received" readonly placeholder="0" class="w-32 text-right text-2xl font-semibold border-2 border-amber-300 rounded-lg p-1 bg-amber-50 focus:outline-none">
                    </div>
                    
                    <div class="flex justify-between items-center text-xl font-bold pt-2">
                        <span>æ‰¾é›¶é‡‘é¡ (TWD):</span>
                        <span id="change-amount" class="text-green-600">$0</span>
                    </div>
                </div>

                <!-- è™›æ“¬éµç›¤èˆ‡å¿«æ·éµ -->
                <div class="grid grid-cols-5 gap-2 pt-4">
                    <!-- å¿«æ·éµ -->
                    <button onclick="quickInput(100)" class="col-span-1 p-3 bg-amber-200 text-gray-800 font-bold rounded-lg shadow hover:bg-amber-300">
                        $100
                    </button>
                    <button onclick="quickInput(500)" class="col-span-1 p-3 bg-amber-200 text-gray-800 font-bold rounded-lg shadow hover:bg-amber-300">
                        $500
                    </button>
                    <button onclick="quickInput(1000)" class="col-span-1 p-3 bg-amber-200 text-gray-800 font-bold rounded-lg shadow hover:bg-amber-300">
                        $1000
                    </button>
                    <button onclick="clearPayment()" class="col-span-2 p-3 bg-red-400 text-white font-bold rounded-lg shadow hover:bg-red-500 keypad-special">
                        æ¸…ç©ºä»˜é¡
                    </button>

                    <!-- æ•¸å­—éµç›¤ -->
                    <!-- ä½¿ç”¨ grid-cols-4 ä¾†å°é½Š 7, 8, 9, Del å’Œä¸‹é¢çš„è¡Œ -->
                    <div class="col-span-5 grid grid-cols-4 gap-2 mt-2">
                        <!-- 7, 8, 9, Del -->
                        <button onclick="keypadInput('7')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">7</button>
                        <button onclick="keypadInput('8')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">8</button>
                        <button onclick="keypadInput('9')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">9</button>
                        <button onclick="keypadInput('del')" class="btn-keypad p-4 bg-red-300 text-white font-bold text-lg rounded-lg shadow hover:bg-red-400">Del</button>
                        
                        <!-- 4, 5, 6, Enter (çµå¸³) æ©«è·¨ 3 è¡Œ -->
                        <button onclick="keypadInput('4')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">4</button>
                        <button onclick="keypadInput('5')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">5</button>
                        <button onclick="keypadInput('6')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">6</button>
                        <!-- çµå¸³æŒ‰éˆ•ç¾åœ¨æ˜¯ col-span-1 å’Œ row-span-3 -->
                        <button onclick="processTransaction()" class="col-span-1 row-span-3 p-3 bg-green-500 text-white font-extrabold text-xl rounded-lg shadow hover:bg-green-600 flex items-center justify-center">
                            çµå¸³
                        </button>
                        
                        <!-- 1, 2, 3 -->
                        <button onclick="keypadInput('1')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">1</button>
                        <button onclick="keypadInput('2')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">2</button>
                        <button onclick="keypadInput('3')" class="btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">3</button>

                        <!-- 0 å’Œ æ¸…ç©ºè¨‚å–® (æ–°ä½ˆå±€) -->
                        <!-- 0 éµ col-span-2 -->
                        <button onclick="keypadInput('0')" class="col-span-2 btn-keypad p-4 bg-white text-gray-800 font-bold text-lg rounded-lg shadow">0</button>
                        
                        <!-- æ¸…ç©ºè¨‚å–® (col-span-1) å¡«è£œ 0 å’Œçµå¸³æŒ‰éˆ•ä¹‹é–“çš„ç©ºé–“ -->
                        <button onclick="clearOrder()" class="col-span-1 p-4 bg-red-600 text-white font-bold text-sm rounded-lg shadow hover:bg-red-700 keypad-special">
                            æ¸…ç©ºè¨‚å–®
                        </button>
                        
                        <!-- æ³¨æ„: é€™è£¡ä¸å†éœ€è¦éš±è—çš„ä½”ä½ divï¼Œå› ç‚ºçµå¸³æŒ‰éˆ•å·²ç¶“ä½”æ“šäº†è©²ä½ç½®ã€‚ -->
                    </div>
                </div>
            </div>

            <!-- 2. æ­·å²è¨‚å–®è¦–åœ– (é è¨­éš±è—) -->
            <div id="history-view" class="hidden flex-col flex-grow overflow-y-auto space-y-4">
                <p class="text-sm text-gray-500">æœ€è¿‘å®Œæˆçš„äº¤æ˜“è¨˜éŒ„ (æœ€æ–°çš„é¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹)ã€‚</p>

                <!-- éŠ·å”®çµ±è¨ˆæ¦‚è¦½ -->
                <div id="history-stats" class="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
                    <h4 class="text-lg font-bold text-blue-700 mb-2">éŠ·å”®çµ±è¨ˆæ¦‚è¦½</h4>
                    <div id="stats-content" class="text-sm text-gray-700 space-y-1">
                        <p>ç¸½è¨‚å–®æ•¸: <span id="stat-total-orders" class="font-semibold text-xl text-blue-600">0</span></p>
                        <div class="pt-2 border-t mt-2">
                             <h5 class="font-semibold text-gray-600">å–®å“éŠ·å”®æ•¸é‡çµ±è¨ˆ:</h5>
                             <ul id="stat-item-list" class="mt-1 space-y-0.5 grid grid-cols-2 gap-x-4">
                                 <!-- çµ±è¨ˆåˆ—è¡¨å°‡ç”± JS æ¸²æŸ“ -->
                             </ul>
                        </div>
                    </div>
                </div>

                <!-- æ–°å¢ï¼šçµç®—èˆ‡æ¸…é™¤æŒ‰éˆ• -->
                <div class="pt-4 border-t border-gray-300">
                    <button onclick="settleAndClearHistory()" class="w-full py-3 bg-red-600 text-white font-extrabold text-lg rounded-lg shadow-xl hover:bg-red-700 transition">
                        ğŸ“Š çµç®—ä¸¦æ¸…ç©ºæ‰€æœ‰æ­·å²è¨‚å–®
                    </button>
                </div>

                <div id="history-list" class="space-y-3">
                    <!-- æ­·å²è¨‚å–®åˆ—è¡¨å°‡ç”± JS æ¸²æŸ“ -->
                </div>
            </div>

        </div>

    </div>

    <!-- Custom Message Box (æ›¿ä»£ alert/confirm) -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl space-y-4"> <!-- èª¿æ•´å¯¬åº¦ä»¥å®¹ç´å ±å‘Šå…§å®¹ -->
            <h3 id="message-title" class="text-xl font-bold text-gray-800">æç¤º</h3>
            <!-- Pre-wrap ç”¨æ–¼ä¿ç•™å ±å‘Šä¸­çš„æ›è¡Œèˆ‡æ ¼å¼ -->
            <p id="message-content" class="text-gray-600 whitespace-pre-wrap font-mono text-sm leading-relaxed"></p> 
            <div class="flex justify-end space-x-2">
                <button id="message-confirm-btn" onclick="hideMessage(true)" class="hidden px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">ç¢ºå®š</button>
                <button id="message-ok-btn" onclick="hideMessage(false)" class="px-4 py-2 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (æ–°å¢è¨­å®šè¦–çª—) -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto space-y-6">
            <h3 class="text-2xl font-bold text-gray-800 border-b pb-2">èœå–®èˆ‡åƒ¹æ ¼è¨­å®š</h3>
            <p class="text-sm text-gray-500">é»æ“Šé …ç›®å¯ä¿®æ”¹åç¨±å’Œåƒ¹æ ¼ï¼Œæˆ–é»æ“Šåˆªé™¤æŒ‰éˆ•ã€‚</p>
            
            <!-- èœå–®é …ç›®åˆ—è¡¨èˆ‡ç·¨è¼¯å€ -->
            <div id="settings-menu-list" class="space-y-4">
                <!-- è¨­å®šé …ç›®å°‡ç”± JS æ¸²æŸ“ -->
            </div>

            <!-- æ–°å¢å“é …è¡¨å–® -->
            <div class="border p-4 rounded-lg bg-gray-50 space-y-3">
                <h4 class="text-lg font-semibold text-gray-700">æ–°å¢å“é …</h4>
                <div class="grid grid-cols-3 gap-3">
                    <input type="text" id="new-item-name" placeholder="å“é …åç¨±" class="col-span-1 p-2 border rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                    <input type="number" id="new-item-price" placeholder="åƒ¹æ ¼ (TWD)" class="col-span-1 p-2 border rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                    <select id="new-item-category" class="col-span-1 p-2 border rounded focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                        <option value="HandBrew">æ‰‹æ²–å’–å•¡</option>
                        <option value="GiftBox">å’–å•¡ç¦®ç›’</option>
                    </select>
                </div>
                <button onclick="addNewMenuItem()" class="w-full py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">
                    æ–°å¢å“é …
                </button>
            </div>

            <div class="flex justify-end">
                <button onclick="closeSettings()" class="px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600">
                    å®Œæˆè¨­å®šä¸¦é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹èœå–®æ•¸æ“š (å¦‚æœ localStorage æ²’æœ‰ï¼Œå‰‡ä½¿ç”¨é€™å€‹)
        const defaultMenuItems = [
            { id: 1, name: 'æ‰‹æ²–å£å‘³1', price: 160, category: 'HandBrew' },
            { id: 2, name: 'æ‰‹æ²–å£å‘³2', price: 110, category: 'HandBrew' },
            { id: 3, name: 'æ‰‹æ²–å£å‘³3', price: 110, category: 'HandBrew' },
            { id: 4, name: 'æ‰‹æ²–å£å‘³4', price: 110, category: 'HandBrew' },
            { id: 5, name: 'æ‰‹æ²–å£å‘³5', price: 110, category: 'HandBrew' },
            // æ–°å¢ç¦®ç›’å“é …
            { id: 6, name: 'ç²‰ç´…çˆºå®¶é›ªè²', price: 450, category: 'GiftBox' },
            { id: 7, name: 'é»‘è‰²æ›¼ç‰¹å¯§', price: 350, category: 'GiftBox' },
        ];
        
        const menuCategories = {
            'HandBrew': 'æ‰‹æ²–å’–å•¡',
            'GiftBox': 'å’–å•¡ç¦®ç›’'
        };

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        let menuItems = []; // å¯¦éš›ä½¿ç”¨çš„èœå–®ï¼Œå¾ localStorage è¼‰å…¥
        let currentOrder = {}; // { itemId: count, ... }
        let totalAmount = 0;
        let orderId = 1; // è¨‚å–®ç·¨è™Ÿ
        let historicalOrders = []; // æ­·å²è¨‚å–®åˆ—è¡¨
        let currentView = 'order'; // ç•¶å‰è¦–åœ– ('order' æˆ– 'history')

        // localStorage å„²å­˜éµ
        const STORAGE_KEY_HISTORY = 'POS_HISTORY'; 
        const STORAGE_KEY_ORDER_ID = 'POS_ORDER_ID'; 
        const STORAGE_KEY_MENU = 'POS_MENU_ITEMS'; 

        // å…¨åŸŸ DOM å…ƒç´ è®Šæ•¸
        let orderIdEl, menuItemsEl, orderDetailsEl, totalAmountEl, amountReceivedEl, changeAmountEl, historyListEl;
        let tabOrderEl, tabHistoryEl, orderViewEl, historyViewEl;
        let messageBoxEl, messageTitleEl, messageContentEl, messageOkBtn, messageConfirmBtn;
        let settingsModalEl, settingsMenuListEl;
        let messageResolve = null; 

        // === è¨Šæ¯å°è©±æ¡†å‡½å¼ (å–ä»£ alert/confirm) ===
        function showMessage(title, content, isConfirm = false) {
            messageTitleEl.textContent = title;
            // è™•ç†å…§å®¹ä¸­çš„ç²—é«”æ¨™è¨˜ (markdown **...)ï¼Œä¸¦ä½¿ç”¨ font-mono æ¨£å¼
            messageContentEl.innerHTML = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            if (isConfirm) {
                messageOkBtn.textContent = 'å–æ¶ˆ';
                messageConfirmBtn.classList.remove('hidden');
            } else {
                messageOkBtn.textContent = 'ç¢ºèª';
                messageConfirmBtn.classList.add('hidden');
            }

            messageBoxEl.classList.remove('hidden');

            return new Promise(resolve => {
                messageResolve = resolve;
            });
        }

        function hideMessage(result) {
            messageBoxEl.classList.add('hidden');
            if (messageResolve) {
                messageResolve(result);
                messageResolve = null;
            }
        }
        
        // === å„²å­˜èˆ‡è¼‰å…¥å‡½å¼ (ä½¿ç”¨ localStorage å¯¦ç¾æŒä¹…åŒ–) ===

        /** å„²å­˜æ‡‰ç”¨ç¨‹å¼çš„ç‹€æ…‹ (æ­·å²è¨‚å–®ã€è¨‚å–®ç·¨è™Ÿã€èœå–®) åˆ° localStorageã€‚ */
        function saveAppState() {
            try {
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(historicalOrders));
                localStorage.setItem(STORAGE_KEY_ORDER_ID, orderId.toString());
                localStorage.setItem(STORAGE_KEY_MENU, JSON.stringify(menuItems)); // å„²å­˜èœå–®
            } catch (e) {
                console.error("ç„¡æ³•å„²å­˜è³‡æ–™åˆ° localStorage:", e);
            }
        }

        /** * å¾ localStorage è¼‰å…¥æ‡‰ç”¨ç¨‹å¼çš„ç‹€æ…‹ï¼Œä¸¦å¢åŠ å°æ­·å²è¨‚å–®çš„å¥å£¯æ€§æª¢æŸ¥ã€‚
         */
        function loadAppState() {
            try {
                // è¼‰å…¥æ­·å²è¨‚å–® (æ–°å¢å¥å£¯æ€§æª¢æŸ¥)
                const historyJson = localStorage.getItem(STORAGE_KEY_HISTORY);
                if (historyJson) {
                    try {
                        const parsedHistory = JSON.parse(historyJson);
                        if (Array.isArray(parsedHistory)) {
                            historicalOrders = parsedHistory;
                        } else {
                            // å¦‚æœè§£æå‡ºçš„ä¸æ˜¯é™£åˆ—ï¼Œå‰‡é‡ç½®ç‚ºç©ºï¼Œä¸¦çµ¦äºˆè­¦å‘Š
                            console.warn("LocalStorage æ­·å²è¨‚å–®è³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–å·²æå£ï¼Œå·²é‡ç½®æ­·å²ç´€éŒ„ã€‚");
                            historicalOrders = [];
                        }
                    } catch (e) {
                        console.error("è§£ææ­·å²è¨‚å–® JSON å¤±æ•—ï¼Œè³‡æ–™å·²æå£:", e);
                        historicalOrders = []; // è§£æå¤±æ•—æ™‚é‡ç½®
                    }
                }
                
                // è¼‰å…¥è¨‚å–®ç·¨è™Ÿ
                const idString = localStorage.getItem(STORAGE_KEY_ORDER_ID);
                if (idString) {
                    const loadedId = parseInt(idString);
                    if (!isNaN(loadedId) && loadedId > 0) {
                        orderId = loadedId;
                    }
                }

                // è¼‰å…¥èœå–® 
                const menuJson = localStorage.getItem(STORAGE_KEY_MENU);
                if (menuJson) {
                    menuItems = JSON.parse(menuJson);
                } else {
                    menuItems = defaultMenuItems;
                }

            } catch (e) {
                console.error("ç„¡æ³•è¼‰å…¥è³‡æ–™å¾ localStorage:", e);
                historicalOrders = [];
                orderId = 1;
                menuItems = defaultMenuItems; // è¼‰å…¥å¤±æ•—æ™‚ï¼Œä½¿ç”¨é è¨­èœå–®
            }
        }

        // === æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ===

        // åˆå§‹åŒ–ï¼šç¢ºä¿åœ¨ DOM å…§å®¹å®Œå…¨è¼‰å…¥å¾Œæ‰åŸ·è¡Œæ‰€æœ‰ DOM ç›¸é—œæ“ä½œ
        document.addEventListener('DOMContentLoaded', () => {
            // è³¦å€¼æ‰€æœ‰ DOM å…ƒç´ 
            orderIdEl = document.getElementById('order-id');
            menuItemsEl = document.getElementById('menu-items');
            orderDetailsEl = document.getElementById('order-details');
            totalAmountEl = document.getElementById('total-amount');
            amountReceivedEl = document.getElementById('amount-received');
            changeAmountEl = document.getElementById('change-amount');
            historyListEl = document.getElementById('history-list');

            tabOrderEl = document.getElementById('tab-order');
            tabHistoryEl = document.getElementById('tab-history');
            orderViewEl = document.getElementById('order-view');
            historyViewEl = document.getElementById('history-view');

            messageBoxEl = document.getElementById('message-box');
            messageTitleEl = document.getElementById('message-title');
            messageContentEl = document.getElementById('message-content');
            messageOkBtn = document.getElementById('message-ok-btn');
            messageConfirmBtn = document.getElementById('message-confirm-btn');

            settingsModalEl = document.getElementById('settings-modal');
            settingsMenuListEl = document.getElementById('settings-menu-list');

            loadAppState(); 
            renderMenuItems();
            updateOrderSummary();
            orderIdEl.textContent = orderId;
            toggleView('order'); 
        });


        // æ¸²æŸ“èœå–®æŒ‰éˆ• (æ›´æ–°ä»¥æ”¯æ´åˆ†é¡)
        function renderMenuItems() {
            if (!menuItemsEl) return;
            menuItemsEl.innerHTML = '';
            
            // æ ¹æ“š category åˆ†çµ„
            const groupedItems = menuItems.reduce((acc, item) => {
                const category = item.category || 'HandBrew'; // ç¢ºä¿æœ‰é¡åˆ¥
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            // æ¸²æŸ“æ¯å€‹é¡åˆ¥
            Object.keys(groupedItems).forEach(categoryKey => {
                const categoryTitle = menuCategories[categoryKey] || 'å…¶ä»–å“é …';

                // é¡åˆ¥æ¨™é¡Œ
                const titleEl = document.createElement('h2');
                titleEl.className = 'text-2xl font-semibold text-gray-700 mt-4 mb-2 border-b border-amber-300 pb-1';
                titleEl.textContent = categoryTitle;
                menuItemsEl.appendChild(titleEl);

                // é¡åˆ¥ä¸‹çš„å“é …åˆ—è¡¨
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4';
                
                groupedItems[categoryKey].forEach(item => {
                    const button = document.createElement('button');
                    button.className = `btn-menu p-4 bg-amber-400 text-white font-semibold text-lg rounded-xl shadow-lg hover:bg-amber-500`;
                    button.innerHTML = `
                        <span class="block text-xl">${item.name}</span>
                        <span class="block text-sm font-light">$${item.price}</span>
                        <span class="block text-xs mt-1 text-amber-900 font-bold">é»æ“ŠåŠ å…¥</span>
                    `;
                    button.onclick = () => addToOrder(item.id);
                    itemsContainer.appendChild(button);
                });
                
                menuItemsEl.appendChild(itemsContainer);
            });
        }

        // å°‡å“é …åŠ å…¥è¨‚å–®
        function addToOrder(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) {
                showMessage('éŒ¯èª¤', 'æ­¤å“é …å·²ä¸å­˜åœ¨æ–¼èœå–®ä¸­ã€‚');
                return;
            }
            if (currentOrder[itemId]) {
                currentOrder[itemId]++;
            } else {
                currentOrder[itemId] = 1;
            }
            updateOrderSummary();
        }

        // ç§»é™¤è¨‚å–®ä¸­çš„å“é … (æ¸›å°‘æ•¸é‡)
        function removeFromOrder(itemId) {
            if (currentOrder[itemId] && currentOrder[itemId] > 0) {
                currentOrder[itemId]--;
                if (currentOrder[itemId] === 0) {
                    delete currentOrder[itemId];
                }
            }
            updateOrderSummary();
        }

        // æ›´æ–°è¨‚å–®ç¸½çµ (æ˜ç´°èˆ‡ç¸½è¨ˆ)
        function updateOrderSummary() {
            if (!orderDetailsEl || !totalAmountEl) return;
            
            orderDetailsEl.innerHTML = '';
            totalAmount = 0;
            const items = Object.keys(currentOrder).filter(key => currentOrder[key] > 0);

            if (items.length === 0) {
                orderDetailsEl.innerHTML = '<p class="text-gray-500 text-center py-4">ç›®å‰ç„¡å“é …</p>';
                totalAmount = 0;
            } else {
                items.forEach(itemIdStr => {
                    const itemId = parseInt(itemIdStr);
                    const item = menuItems.find(i => i.id === itemId);
                    
                    // è™•ç†èœå–®å·²åˆªé™¤ä½†è¨‚å–®ä¸­ä»æœ‰çš„æƒ…æ³
                    if (!item) {
                        const deletedItemName = 'å·²åˆªé™¤å“é …'; // é¡¯ç¤ºæ›¿ä»£åç¨±
                        const count = currentOrder[itemId];
                        const detailRow = document.createElement('div');
                        detailRow.className = 'flex justify-between items-center border-b border-gray-100 py-1 bg-red-50';
                         detailRow.innerHTML = `
                            <div class="flex items-center space-x-2">
                                <button onclick="removeFromOrder(${itemId})" class="text-red-500 hover:text-red-700 font-bold text-lg">-</button>
                                <span class="text-gray-700 font-medium">${deletedItemName} (ID:${itemId})</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="font-mono text-gray-600">${count} x N/A</span>
                                <span class="font-bold text-gray-800">N/A</span>
                            </div>
                        `;
                        orderDetailsEl.appendChild(detailRow);
                        return; // è·³éç¸½è¨ˆè¨ˆç®—ï¼Œå› ç‚ºåƒ¹æ ¼æœªçŸ¥
                    }

                    const count = currentOrder[itemId];
                    const subtotal = item.price * count;
                    totalAmount += subtotal;

                    const detailRow = document.createElement('div');
                    detailRow.className = 'flex justify-between items-center border-b border-gray-100 py-1';
                    detailRow.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <button onclick="removeFromOrder(${item.id})" class="text-red-500 hover:text-red-700 font-bold text-lg">-</button>
                            <span class="text-gray-700 font-medium">${item.name}</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="font-mono text-gray-600">${count} x $${item.price}</span>
                            <span class="font-bold text-gray-800">$${subtotal}</span>
                        </div>
                    `;
                    orderDetailsEl.appendChild(detailRow);
                });
            }

            totalAmountEl.textContent = `$${totalAmount}`;
            calculateChange(); 
        }
        
        // è™›æ“¬éµç›¤è¼¸å…¥é‚è¼¯
        function keypadInput(key) {
            if (!amountReceivedEl) return;
            
            let currentValue = amountReceivedEl.value || '';
            
            if (key === 'del') {
                amountReceivedEl.value = currentValue.slice(0, -1);
            } else if (key === '.') {
                // å‡è¨­æ˜¯æ•´æ•¸äº¤æ˜“ï¼Œä¸å…è¨±å°æ•¸é»
            } else {
                if (currentValue.length < 8) {
                    amountReceivedEl.value = currentValue + key;
                }
            }
            
            if (amountReceivedEl.value.startsWith('0') && amountReceivedEl.value.length > 1) {
                amountReceivedEl.value = amountReceivedEl.value.substring(1);
            }
            
            calculateChange();
        }

        // å¿«é€Ÿè¼¸å…¥æŒ‰éˆ•
        function quickInput(amount) {
            if (!amountReceivedEl) return;
            let current = parseInt(amountReceivedEl.value) || 0;
            amountReceivedEl.value = current + amount;
            calculateChange();
        }
        
        // æ¸…ç©ºä»˜ç¾é‡‘é¡
        function clearPayment() {
            if (!amountReceivedEl) return;
            amountReceivedEl.value = '';
            calculateChange();
        }

        // è¨ˆç®—æ‰¾é›¶
        function calculateChange() {
            if (!amountReceivedEl || !changeAmountEl) return;
            
            const received = parseInt(amountReceivedEl.value) || 0;
            
            if (totalAmount === 0) {
                changeAmountEl.textContent = '$0';
                changeAmountEl.className = 'text-xl font-bold pt-2 text-green-600';
                return;
            }

            const change = received - totalAmount;

            if (change >= 0) {
                changeAmountEl.textContent = `$${change}`;
                changeAmountEl.className = 'text-xl font-bold pt-2 text-green-600';
            } else {
                changeAmountEl.textContent = `$${Math.abs(change)} (ä¸è¶³)`;
                changeAmountEl.className = 'text-xl font-bold pt-2 text-red-600'; 
            }
        }

        // è™•ç†äº¤æ˜“ (çµå¸³) 
        async function processTransaction() {
            if (totalAmount === 0) {
                await showMessage('éŒ¯èª¤', 'è«‹å…ˆé»é¸å“é …åŠ å…¥è¨‚å–®ï¼');
                return;
            }

            const received = parseInt(amountReceivedEl.value) || 0;
            const change = received - totalAmount;
            
            if (change < 0) {
                await showMessage('éŒ¯èª¤', `ä»˜ç¾é‡‘é¡ä¸è¶³ï¼å°šéœ€è£œè¶³ $${Math.abs(change)}ã€‚`);
                return;
            }

            // 1. å„²å­˜æ­·å²è¨‚å–®
            const totalItemsCount = Object.values(currentOrder).reduce((sum, count) => sum + count, 0);

            // å­˜å„²çš„ items æ‡‰åŒ…å«åç¨±å’Œåƒ¹æ ¼ï¼Œä»¥ç¢ºä¿æ­·å²è¨‚å–®çš„æº–ç¢ºæ€§
            const itemsSnapshot = Object.keys(currentOrder).map(itemIdStr => {
                const itemId = parseInt(itemIdStr);
                const itemData = menuItems.find(i => i.id === itemId) || { name: 'æœªçŸ¥/å·²åˆªé™¤å“é …', price: 0 };
                return {
                    id: itemId,
                    name: itemData.name,
                    price: itemData.price,
                    count: currentOrder[itemId]
                };
            });

            const completedOrder = {
                id: orderId,
                items: itemsSnapshot, // å„²å­˜åŒ…å«åç¨±å’Œåƒ¹æ ¼çš„å¿«ç…§
                total: totalAmount,
                received: received,
                change: change,
                totalItemsCount: totalItemsCount,
                timestamp: new Date().toLocaleString('zh-TW', { hour12: false }),
            };

            historicalOrders.unshift(completedOrder); 
            saveAppState(); 

            // 2. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            await showMessage('äº¤æ˜“æˆåŠŸ', `å–®è™Ÿ: ${orderId}\nç¸½è¨ˆ: $${totalAmount}\nä»˜ç¾: $${received}\næ‰¾é›¶: $${change}`);

            // 3. é‡ç½®ç‹€æ…‹
            currentOrder = {};
            totalAmount = 0;
            amountReceivedEl.value = '';
            orderId++; 
            orderIdEl.textContent = orderId;
            saveAppState(); 
            
            updateOrderSummary();
            toggleView('order');
        }

        // æ¸…é™¤æ•´å€‹è¨‚å–®
        async function clearOrder() {
            if (Object.keys(currentOrder).length === 0) {
                await showMessage('æç¤º', 'ç›®å‰è¨‚å–®å·²æ˜¯ç©ºçš„ï¼Œç„¡éœ€æ¸…é™¤ã€‚');
                return;
            }
            
            const confirmed = await showMessage('ç¢ºèªæ¸…é™¤', 'ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨‚å–®å“é …å—ï¼Ÿ', true);

            if (confirmed) {
                currentOrder = {};
                totalAmount = 0;
                amountReceivedEl.value = '';
                updateOrderSummary();
                await showMessage('æç¤º', 'è¨‚å–®å·²æ¸…é™¤ã€‚');
            }
        }

        // === æ­·å²è¨‚å–®çµ±è¨ˆåŠŸèƒ½ ===

        /** è¨ˆç®—æ‰€æœ‰æ­·å²è¨‚å–®ä¸­æ¯å€‹å“é …çš„ç¸½éŠ·å”®æ•¸é‡ */
        function calculateItemStatistics() {
            const stats = {};
            let totalOrders = historicalOrders.length;

            historicalOrders.forEach(order => {
                order.items.forEach(item => {
                    const itemName = item.name;
                    const count = item.count;
                    
                    if (!stats[itemName]) {
                        stats[itemName] = 0;
                    }
                    stats[itemName] += count;
                });
            });

            return { stats, totalOrders };
        }

        // æ¸²æŸ“æ­·å²è¨‚å–® (æ›´æ–°ä»¥é¡¯ç¤ºçµ±è¨ˆ)
        function renderHistoricalOrders() {
            if (!historyListEl) return;
            historyListEl.innerHTML = '';
            
            // 1. æ¸²æŸ“çµ±è¨ˆæ•¸æ“š
            const { stats, totalOrders } = calculateItemStatistics();
            const statTotalOrdersEl = document.getElementById('stat-total-orders');
            if (statTotalOrdersEl) statTotalOrdersEl.textContent = totalOrders;
            
            const statListEl = document.getElementById('stat-item-list');
            if (!statListEl) return;
            statListEl.innerHTML = '';
            
            const sortedStats = Object.entries(stats).sort(([, a], [, b]) => b - a);

            if (sortedStats.length === 0) {
                statListEl.innerHTML = '<li class="col-span-2 text-gray-500">æš«ç„¡éŠ·å”®æ•¸æ“šã€‚</li>';
            } else {
                sortedStats.forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between';
                    li.innerHTML = `<span>${name}:</span><span class="font-extrabold text-blue-500">${count}</span>`;
                    statListEl.appendChild(li);
                });
            }

            // 2. æ¸²æŸ“è¨‚å–®åˆ—è¡¨
            if (historicalOrders.length === 0) {
                historyListEl.innerHTML = '<p class="text-gray-500 text-center py-4">å°šç„¡æ­·å²äº¤æ˜“è¨˜éŒ„ã€‚</p>';
                return;
            }

            historicalOrders.forEach(order => {
                const historyCard = document.createElement('div');
                historyCard.className = 'bg-white p-4 rounded-xl shadow-md border-l-4 border-amber-500 space-y-2';
                
                // å»ºç«‹æ˜ç´°åˆ—è¡¨
                const itemDetails = order.items.map(item => 
                    `<li class="flex justify-between text-xs text-gray-500">
                        <span>${item.name}</span>
                        <span>${item.count} x $${item.price}</span>
                    </li>`
                ).join('');

                historyCard.innerHTML = `
                    <div class="flex justify-between items-center pb-1 border-b border-gray-100">
                        <span class="text-lg font-bold text-gray-800">å–®è™Ÿ: ${order.id}</span>
                        <span class="text-sm text-gray-500">${order.timestamp}</span>
                    </div>
                    
                    <ul class="list-disc pl-4 space-y-1">${itemDetails}</ul>
                    
                    <div class="flex justify-between text-sm text-gray-700 pt-2 border-t">
                        <span>ç¸½è¨ˆé‡‘é¡:</span>
                        <span class="font-bold text-red-600 text-lg">$${order.total}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-700">
                        <span>æ‰¾é›¶:</span>
                        <span class="font-bold text-green-600">$${order.change}</span>
                    </div>
                `;
                historyListEl.appendChild(historyCard);
            });
        }

        // === æ–°å¢ï¼šçµç®—ä¸¦æ¸…ç©ºæ­·å²è¨‚å–®çš„å‡½æ•¸ (å·²ä¿®æ­£é‡è¨­ orderId çš„å•é¡Œ) ===
        async function settleAndClearHistory() {
            if (historicalOrders.length === 0) {
                await showMessage('æ“ä½œæç¤º', 'ç›®å‰æ­·å²è¨‚å–®è¨˜éŒ„ç‚ºç©ºï¼Œç„¡éœ€åŸ·è¡Œçµç®—æ“ä½œã€‚');
                return;
            }

            // 1. åŸ·è¡Œçµç®—çµ±è¨ˆ
            const { stats, totalOrders } = calculateItemStatistics();
            
            // è¨ˆç®—ç¸½éŠ·å”®é‡‘é¡
            let totalRevenue = 0;
            historicalOrders.forEach(order => {
                totalRevenue += order.total;
            });

            // æ‰¾å‡ºæœ€æš¢éŠ·çš„å“é …
            const sortedStats = Object.entries(stats).sort(([, a], [, b]) => b - a);
            const topSeller = sortedStats.length > 0 ? sortedStats[0] : ['ç„¡', 0];
            
            // æ‰¾å‡ºæœ€æ—©èˆ‡æœ€æ™šçš„äº¤æ˜“æ—¥æœŸ
            const firstOrder = historicalOrders[historicalOrders.length - 1]; 
            const lastOrder = historicalOrders[0];
            const totalItemsSold = Object.values(stats).reduce((sum, count) => sum + count, 0);

            // 2. æº–å‚™æ­£å¼çš„å ±å‘Šå…§å®¹ (ç¬¦åˆæ®µè½å¼ã€å ±å‘Šé¢¨æ ¼)
            const reportContent = `
**[æ­£å¼çµç®—è©•ä¼°å ±å‘Š]**
---
**çµç®—é€±æœŸæ¦‚è¿°ï¼š**
æœ¬æ¬¡çµç®—æ¶µè“‹äº† **${totalOrders} ç­†**æ­·å²äº¤æ˜“è¨˜éŒ„ã€‚çµç®—æœŸé–“å¾æœ€æ—©çš„äº¤æ˜“æ™‚é–“é» **${firstOrder.timestamp}** è‡³æœ€è¿‘çš„äº¤æ˜“æ™‚é–“é» **${lastOrder.timestamp}** ç‚ºæ­¢ã€‚é€™æ®µæœŸé–“å…§ï¼Œç¸½ç‡Ÿæ¥­é¡ï¼ˆTotal Revenueï¼‰é”åˆ° **$${totalRevenue} TWD**ï¼Œé¡¯ç¤ºäº†ç©©å®šçš„ç‡Ÿé‹è¡¨ç¾ã€‚

**å–®å“éŠ·å”®åˆ†æï¼š**
åœ¨æ‰€æœ‰è²©å”®çš„å“é …ä¸­ï¼Œå…±è¨ˆæœ‰ **${Object.keys(stats).length} ç¨®**ä¸åŒçš„ç”¢å“ç”¢ç”ŸéŠ·å”®ã€‚æ‰€æœ‰å“é …ç¸½å…±å”®å‡º **${totalItemsSold} å€‹**ã€‚
éŠ·å”®æ•¸é‡æœ€é«˜çš„ç”¢å“æ˜¯ **ã€Œ${topSeller[0]}ã€**ï¼Œç¸½å…±å”®å‡º **${topSeller[1]} å€‹**ï¼Œå…¶ç‚ºæœ¬æœŸçš„éŠ·å”®ä¸»åŠ›ï¼Œä½”ç¸½éŠ·é‡ç´„ **${(topSeller[1] / totalItemsSold * 100).toFixed(1)}%**ã€‚

**æ“ä½œå»ºè­°ï¼š**
åœ¨ç¢ºèªæ­¤å ±å‘Šå…§å®¹ç„¡èª¤ä¸¦è¨˜éŒ„å®Œç•¢å¾Œï¼Œå»ºè­°åŸ·è¡Œæ¸…é™¤æ“ä½œä»¥å„ªåŒ–ç³»çµ±æ€§èƒ½ä¸¦æº–å‚™è¿æ¥æ–°çš„çµç®—é€±æœŸã€‚

**è«‹ç¢ºèªæ‚¨æ˜¯å¦è¦åŸ·è¡Œæ¸…é™¤æ“ä½œã€‚**
`;

            // 3. å½ˆå‡ºç¢ºèªè¦–çª—
            const confirmed = await showMessage(
                'çµç®—å ±å‘ŠåŠæ¸…é™¤ç¢ºèª', 
                reportContent, 
                true // è¨­å®šç‚ºç¢ºèªæ¨¡å¼ (Confirm)
            );

            // 4. åŸ·è¡Œæ¸…é™¤
            if (confirmed) {
                // æ¸…ç©ºæ­·å²è¨‚å–®
                historicalOrders = [];
                
                // === é—œéµä¿®æ­£ï¼šé‡è¨­è¨‚å–® ID è‡³ 1 ===
                orderId = 1; 
                orderIdEl.textContent = orderId; 
                // ===================================
                
                saveAppState(); // å„²å­˜ç©ºçš„æ­·å²å’Œæ–°çš„ orderId
                
                // é‡æ–°æ¸²æŸ“æ­·å²è¦–åœ–
                renderHistoricalOrders();
                
                // æˆåŠŸæç¤º
                await showMessage('æ“ä½œæˆåŠŸ', 'æ­·å²è¨‚å–®æ•¸æ“šå·²æˆåŠŸçµç®—ä¸¦æ¸…é™¤ï¼è¨‚å–®ç·¨è™Ÿå·²é‡è¨­ç‚º 1ã€‚');
            } else {
                await showMessage('æ“ä½œå–æ¶ˆ', 'çµç®—æ“ä½œå·²å–æ¶ˆï¼Œæ­·å²è¨˜éŒ„ä¿æŒä¸è®Šã€‚');
            }
        }


        // åˆ‡æ›è¦–åœ–
        function toggleView(view) {
            if (!tabOrderEl || !tabHistoryEl || !orderViewEl || !historyViewEl) {
                 console.error("DOM å…ƒç´ å°šæœªè¼‰å…¥ï¼Œç„¡æ³•åˆ‡æ›è¦–åœ–ï¼");
                 return;
            }
            
            currentView = view;
            
            if (view === 'order') {
                tabOrderEl.className = 'flex-1 py-2 px-4 text-center font-bold text-lg rounded-t-lg transition-colors border-b-4 border-amber-500 text-amber-600';
                tabHistoryEl.className = 'flex-1 py-2 px-4 text-center font-bold text-lg rounded-t-lg text-gray-500 hover:text-gray-700 border-b-4 border-transparent';
                
                orderViewEl.classList.remove('hidden');
                historyViewEl.classList.add('hidden');
            } else { 
                tabOrderEl.className = 'flex-1 py-2 px-4 text-center font-bold text-lg rounded-t-lg text-gray-500 hover:text-gray-700 border-b-4 border-transparent';
                tabHistoryEl.className = 'flex-1 py-2 px-4 text-center font-bold text-lg rounded-t-lg transition-colors border-b-4 border-amber-500 text-amber-600';
                
                orderViewEl.classList.add('hidden');
                historyViewEl.classList.remove('hidden'); 
                renderHistoricalOrders(); 
            }
        }

        // === èœå–®è¨­å®šåŠŸèƒ½ (èˆ‡åŸç¨‹å¼ç¢¼ç›¸åŒ) ===

        /** é–‹å•Ÿè¨­å®šæ¨¡æ…‹è¦–çª— */
        function openSettings() {
            if (!settingsModalEl) return;
            renderSettingsList();
            settingsModalEl.classList.remove('hidden');
        }

        /** é—œé–‰è¨­å®šæ¨¡æ…‹è¦–çª— */
        function closeSettings() {
            if (!settingsModalEl) return;
            // é‡æ–°æ¸²æŸ“ä¸»èœå–®ä»¥æ‡‰ç”¨ä»»ä½•è®Šæ›´
            renderMenuItems();
            // é‡æ–°è¨ˆç®—ç•¶å‰è¨‚å–® (ä»¥é˜²æœ‰å“é …è¢«åˆªé™¤æˆ–åƒ¹æ ¼è®Šæ›´)
            updateOrderSummary(); 
            settingsModalEl.classList.add('hidden');
        }

        /** æ¸²æŸ“è¨­å®šä»‹é¢ä¸­çš„èœå–®åˆ—è¡¨ */
        function renderSettingsList() {
            if (!settingsMenuListEl) return;
            settingsMenuListEl.innerHTML = '';
            
            // æ ¹æ“š category åˆ†çµ„æ¸²æŸ“
            const groupedItems = menuItems.reduce((acc, item) => {
                const category = item.category || 'HandBrew';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            Object.keys(groupedItems).forEach(categoryKey => {
                const categoryTitle = menuCategories[categoryKey] || 'å…¶ä»–å“é …';

                const titleEl = document.createElement('h4');
                titleEl.className = 'text-xl font-bold text-gray-700 mt-4 mb-2';
                titleEl.textContent = categoryTitle;
                settingsMenuListEl.appendChild(titleEl);

                groupedItems[categoryKey].forEach(item => {
                    const row = document.createElement('div');
                    row.id = `setting-item-${item.id}`;
                    row.className = 'item-setting-row flex items-center justify-between p-3 bg-white border rounded-lg shadow-sm';
                    row.innerHTML = `
                        <!-- ç·¨è¼¯æ¬„ä½ -->
                        <div class="flex-1 grid grid-cols-3 gap-2 items-center">
                            <input type="text" value="${item.name}" 
                                id="name-${item.id}" 
                                class="p-1 border rounded focus:border-amber-500" 
                                onchange="editMenuItem(${item.id}, 'name', this.value)">
                            <input type="number" value="${item.price}" 
                                id="price-${item.id}" 
                                class="p-1 border rounded text-right focus:border-amber-500" 
                                onchange="editMenuItem(${item.id}, 'price', parseInt(this.value) || 0)">
                            <select id="category-${item.id}" class="p-1 border rounded focus:border-amber-500" onchange="editMenuItem(${item.id}, 'category', this.value)">
                                ${Object.keys(menuCategories).map(key => 
                                    `<option value="${key}" ${item.category === key ? 'selected' : ''}>${menuCategories[key]}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <!-- åˆªé™¤æŒ‰éˆ• -->
                        <button onclick="deleteMenuItem(${item.id})" class="ml-4 p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                            <!-- åƒåœ¾æ¡¶åœ–ç¤º -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    `;
                    settingsMenuListEl.appendChild(row);
                });
            });
        }

        /** ç·¨è¼¯ç¾æœ‰èœå–®å“é … */
        function editMenuItem(id, key, value) {
            const index = menuItems.findIndex(item => item.id === id);
            if (index !== -1) {
                // ç¢ºä¿åƒ¹æ ¼ä¸ç‚ºè² 
                if (key === 'price' && value < 0) {
                    value = 0;
                    const priceEl = document.getElementById(`price-${id}`);
                    if (priceEl) priceEl.value = 0;
                }
                menuItems[index][key] = value;
                saveAppState();
            }
        }

        /** åˆªé™¤èœå–®å“é … */
        async function deleteMenuItem(id) {
            const confirmed = await showMessage('ç¢ºèªåˆªé™¤', `ç¢ºå®šè¦åˆªé™¤æ­¤å“é …å—? åˆªé™¤å¾Œéœ€è¦é‡æ–°æ•´ç†é é¢æ‰èƒ½æ¸…é™¤ç•¶å‰è¨‚å–®ä¸­æ­¤å“é …çš„é¤˜é¡è¨ˆç®—ã€‚`, true);
            
            if (confirmed) {
                menuItems = menuItems.filter(item => item.id !== id);
                const itemEl = document.getElementById(`setting-item-${id}`);
                if (itemEl) itemEl.remove();
                saveAppState();
            }
        }

        /** æ–°å¢èœå–®å“é … */
        async function addNewMenuItem() {
            const nameInput = document.getElementById('new-item-name');
            const priceInput = document.getElementById('new-item-price');
            const categoryInput = document.getElementById('new-item-category');

            if (!nameInput || !priceInput || !categoryInput) {
                console.error("æ–°å¢å“é …è¡¨å–®å…ƒç´ éºå¤±ã€‚");
                return;
            }

            const name = nameInput.value.trim();
            const price = parseInt(priceInput.value);
            const category = categoryInput.value;

            if (!name) {
                await showMessage('éŒ¯èª¤', 'è«‹è¼¸å…¥å“é …åç¨±ã€‚');
                return;
            }
            if (isNaN(price) || price < 0) {
                await showMessage('éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼ (éè² æ•¸)ã€‚');
                return;
            }

            // å–å¾—æ–°çš„ ID (æ‰¾åˆ°æœ€å¤§çš„ ID + 1)
            const newId = menuItems.length > 0 ? Math.max(...menuItems.map(item => item.id)) + 1 : 1;

            const newItem = {
                id: newId,
                name: name,
                price: price,
                category: category
            };

            menuItems.push(newItem);
            saveAppState();
            
            // æ¸…ç©ºè¡¨å–®ä¸¦é‡æ–°æ¸²æŸ“è¨­å®šåˆ—è¡¨
            nameInput.value = '';
            priceInput.value = '';
            renderSettingsList();

            await showMessage('æˆåŠŸ', `å“é … "${name}" å·²æˆåŠŸæ–°å¢ï¼`);
        }
    </script>
</body>
</html>